#!/usr/bin/env perl

use Mojolicious::Lite;
use Email::MIME;
use IO::All;
use Email::Sender::Simple qw(sendmail);
use Email::Sender::Transport::SMTP ();
#use Email::Simple ();
#use Email::Simple::Creator ();

post '/betasignup' => sub {
    my $self = shift;
    
    my $jsonReq = $self->req->json;
    my $email = $jsonReq->{email};
    #my $email = $self->param('email');

    open(EMAILS, '>>', 'emails.txt');
    print EMAILS $email . "\n";
    close EMAILS;
    
    my $base64Img = "";

    my @parts = (
        Email::MIME->create(
            attributes => {
                content_type => "text/html"
            },
            body => "<html><head></head><body><table style=\"font-size:12pt;font-family:Lato Light,sans-serif;color:#898989\"><tr><td><img src=\"http://annotree.com/Email/HeaderLeft.png\" border=\"0\" alt=\"\" /><a href=\"http://annotree.com\"><img style=\"float:right\" src=\"http://annotree.com/Email/HeaderRight.png\" border=\"0\" alt=\"AnnoTree\" /></a></td></tr><tr><td>Thanks for signing up for the AnnoTree beta. We are currently rolling in users to test our platform and will reach out to you soon when we're ready to bring you on board.<br/><br/>In the meantime, we invite you to follow us on social media and at <a href=\"http://blog.annotree.com\">http://blog.annotree.com</a> to stay up-to-date on our product, our vision, and how AnnoTree will reshape the mobile development space.<br/><br/>If you have any questions, please feel free to reply to this email and we'll get back to you as soon as possible!<br/><br/>Sincerely,<br/>The AnnoTree Team<br/><br/><a href=\"https://www.facebook.com/annotreeapp\"><img src=\"http://annotree.com/Email/facebook.png\" height=\"30\" width=\"30\" border=\"0\" alt=\"Facebook\" /></a>  <a href=\"https://twitter.com/AnnoTree\"><img src=\"http://annotree.com/Email/twitter.png\" height=\"30\" width=\"30\" border=\"0\" alt=\"Twitter\" /></a></td></tr></table></body></html>"
        )
    );

    my $smtpserver = 'smtp.mailgun.org';
    my $smtpport = 587;
    my $smtpuser   = 'postmaster@annotree.com';
    my $smtppassword = '8-7sigqno8u7';

    my $transport = Email::Sender::Transport::SMTP->new({
      host          => $smtpserver,
      port          => $smtpport,
      sasl_username => $smtpuser,
      sasl_password => $smtppassword
    });

    my $emailObj = Email::MIME->create(
      header => [
        To              => $email,
        From            => '"AnnoTree" <invite@annotree.com>',
        Subject         => 'Thanks for Signing Up for AnnoTree',
        content_type    => 'multipart/mixed'
      ],
      parts => [@parts]
    );

    sendmail($emailObj, { transport => $transport }); 
    
    $self->render(status => 204, text => 'Success');
};

app->start;
